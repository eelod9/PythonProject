(()=>{"use strict";const e=()=>{};class t{constructor(){this._subscribers=[]}add(e){this._subscribers.push(e)}unsubscribe(){this._subscribers.forEach((e=>e.unsubscribe()))}}class i{constructor(e){this._setupFn=e}subscribe(i,s,n){const r=((t=e,i=e,s=e)=>"function"!=typeof t?t:{next:t,error:i,complete:s})(i,s,n);let o,a=!0;const c={next:e=>{a&&r.next(e)},complete:()=>{a&&(o&&o(),r.complete(),a=!1)},error:e=>{a&&(r.error(e),a=!1)}};o=this._setupFn(c),a||o&&o();const l=new t;return l.add({unsubscribe:()=>{o&&o(),a=!1}}),l}}class s{constructor(e){this.value=e,this.complete=!1,this.skip=!1}}const n=e=>(...t)=>new i((i=>{const n=e.subscribe((e=>{return n=void 0,r=void 0,a=function*(){try{let n=new s(e);for(const e of t){const t=e(n);if(n=t.then?yield t:t,!0===n.skip||!0===n.complete)break}if(n.skip)return;i.next(n.value),!0===n.complete&&i.complete()}catch(e){i.error(e)}},new((o=void 0)||(o=Promise))((function(e,t){function i(e){try{c(a.next(e))}catch(e){t(e)}}function s(e){try{c(a.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o((function(e){e(n)}))).then(i,s)}c((a=a.apply(n,r||[])).next())}));var n,r,o,a}),(e=>i.error(e)),(()=>i.complete()));return()=>n.unsubscribe()})),r=e=>t=>(!1===e(t.value)&&(t.skip=!0),t),o=e=>t=>(e?!0===e(t.value)?t.complete=!0:t.skip=!0:t.complete=!0,t);function a(e=5){let t="";const i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=i.length;for(let n=0;n<e;n++)t+=i.charAt(Math.floor(Math.random()*s));return t}new RegExp("^\\d{4}-\\d{2}-\\d{2}((T\\d{2}:\\d{2}(:\\d{2})?)(\\.\\d{1,6})?(Z|(\\+|-)\\d{2}:\\d{2})?)?$");const c=(e=0)=>new Promise((t=>setTimeout(t,e))),l="sender-alias",d="sender-id",h="REQUEST_TIMEOUT_ERROR";class u extends Error{constructor(e,t){var i,s;super(e),this.name=null!==(i=null==t?void 0:t.name)&&void 0!==i?i:this.name,this.code=null==t?void 0:t.code,this.additionalInformation=null==t?void 0:t.additionalInformation,this.handled=null!==(s=null==t?void 0:t.handled)&&void 0!==s&&s}}class g{constructor(e){this.ID=e.ID,this.eventType=e.eventType,this.body=e.body||{},this.headers=e.headers||{},this.hasError=e.hasError||!1,this.isResponse=!!e.isResponse}}var p=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};class v{constructor(e){var t;this.options=e,this.id=this.options.id||a(10),this.alias=this.options.alias||"No Alias",this.connection=this.options.connection,this.timeoutDuration=null!==(t=this.options.timeoutDuration)&&void 0!==t?t:1e4,this.interceptors=[]}addInterceptor(e){this.interceptors.push(e)}send(e,{body:t,headers:i={}}={}){return p(this,void 0,void 0,(function*(){const s=this.runInterceptors(this.createRequest(e,t,i)),r=new Promise(((t,i)=>p(this,void 0,void 0,(function*(){let r=!1;const a=setTimeout((()=>{r||(i(new u(`Request timed out for ${e}`,{code:h})),r=!0)}),this.timeoutDuration);n(this.connection.onMessage)(o((e=>e.ID===s.ID))).subscribe((s=>{if(r)return;if(clearTimeout(a),!s)return void i(new u(`Wrong request format for ${e}`,{code:"REQUEST_FORMAT_ERROR"}));const n=this.runInterceptors(s);!0===n.hasError?i(n.body):t(n)}))}))));return this.connection.send(s),r}))}runInterceptors(e){const t=(e=>{const t=new WeakMap,i=e=>{if(!e||"object"!=typeof e)return e;let s;const n=Array.isArray(e)?[]:{},r=Object.getPrototypeOf(n);t.set(e,n);for(const o in e)r[o]||(s=e[o],s&&"object"==typeof s?t.get(s)?n[o]=t.get(s):n[o]=i(s):n[o]=s);return n};return i(e)})(e);for(const e of this.interceptors)e(t);return t}createRequest(e,t,i){return new g({ID:a(10),eventType:e,body:t,headers:Object.assign({[l]:this.alias,[d]:this.id},i)})}}class _ extends i{constructor(){super((e=>(this._isComplete&&e.complete(),this._observers.push(e),()=>this._observers=this._observers.filter((t=>t!==e))))),this._observers=[],this._isComplete=!1}next(e){for(const t of this._observers)t.next(e)}error(e){for(const t of this._observers)t.error(e)}complete(){this._isComplete=!0;for(const e of this._observers)e.complete()}asObservable(){return new i((e=>{const t=this.subscribe(e);return()=>t.unsubscribe()}))}}const S=(e,t)=>new Promise(((i,s)=>{let n;"object"==typeof t&&(n=t.defaultValue),e.subscribe((e=>n=e),(e=>s(e)),(()=>i(n)))})),m=(e,t)=>new i((i=>{const s=e=>i.next(e);return e.addEventListener(t,s),()=>e.removeEventListener(t,s)}));class I{constructor(){this.middleware=[],this.handlers={}}getHandlers(){const e={};for(const[t,i]of Object.entries(this.handlers))e[t]=[...this.middleware,...i];return e}use(e){this.middleware.push(e)}on(e,...t){this.handlers[e]=t}}class f{constructor(e,t){this.connection=e,this.event=t,this.data={},this.isSent=!1,this.responseHeaders={}}getHeaders(){return this.event.headers}getEvent(){return this.event.eventType}getContext(e){return this.data[e]}setResponseHeader(e,t){this.responseHeaders[e]=t}setContext(e,t){this.data[e]=t}getBody(){return this.event.body}setBody(e){this.event.body=e}sendError(e){this.validate(e),e instanceof Error&&(e=this.convertErrorToObject(e));const t=new g({ID:this.event.ID,eventType:this.event.eventType,body:e,headers:this.responseHeaders,hasError:!0,isResponse:!0});this.connection.send(t),this.isSent=!0}send(e){this.validate(e);const t=new g({ID:this.event.ID,eventType:this.event.eventType,body:e,headers:this.responseHeaders,isResponse:!0});this.connection.send(t),this.isSent=!0}hasSent(){return this.isSent}validate(e){if(!0===this.isSent)throw{name:"HandlerContext.RESPONSE_ALREADY_SENT",message:"HandlerContext: Response already sent.",code:"RESPONSE_ALREADY_SENT",additionalInformation:{response:e}}}convertErrorToObject(e){return{message:e.message,name:e.name,stack:e.stack,code:e.code,handled:e.handled,additionalInformation:e.additionalInformation}}}var y=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};class w{constructor(e){this.options=e,this.onMessage=e=>t=>((e,...t)=>y(void 0,void 0,void 0,(function*(){const i=e;let s=!1;const[n,r]=function(e){const t=[];return[e.filter((e=>!(e.length>1&&(t.push(e),1)))),t]}(t),o=(e,t)=>y(void 0,void 0,void 0,(function*(){if(!r.length)throw t;for(const i of r)yield i(e,t)}));for(const e of n)try{yield e(i)}catch(e){s=!0,yield o(i,e);break}s||i.hasSent()||(yield o(i,new Error(`Context: Response never sent for ${i.getEvent()}`)))})))(new f(this.connection,t),...this.middleware,...e),this.connection=this.options.connection,this.subscription=new t,this.handlers=[],this.middleware=[]}use(e){if(e instanceof I){const t=e.getHandlers();for(const[e,i]of Object.entries(t))this.on(e,...i)}else this.middleware.push(e)}on(e,...t){if(this.handlers.includes(e))throw new Error("HandlerExists");this.handlers.push(e);const i=n(this.connection.onMessage)(r((t=>t.eventType===e)));this.subscription.add(i.subscribe(this.onMessage(t)))}close(){this.subscription.unsubscribe()}}var E=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};class T{constructor(e,t){this.transmitter=e,this.router=t}eject(){return{transmitter:this.transmitter,router:this.router}}addInterceptor(e){return E(this,void 0,void 0,(function*(){this.transmitter.addInterceptor(e)}))}send(e,t={}){return E(this,void 0,void 0,(function*(){return this.transmitter.send(e,t)}))}use(e){return E(this,void 0,void 0,(function*(){this.router.use(e)}))}on(e,...t){return E(this,void 0,void 0,(function*(){this.router.on(e,...t)}))}close(){return E(this,void 0,void 0,(function*(){this.router.close()}))}}class R{constructor(){this.fulfilled=!1,this.rejected=!1,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t})).then((e=>(this.fulfilled=!0,e)),(e=>{throw this.rejected=!0,e}))}isFulfilled(){return this.fulfilled}isPending(){return!this.isFulfilled()&&!this.isRejected()}isRejected(){return this.rejected}static resolve(e){const t=new R;return t.resolve(e),t}}var C=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};class P{constructor(){this.hasConnected=!1,this.transmitter=new R,this.router=new R}setEngine(e){const{router:t,transmitter:i}=e.eject();this.router.resolve(t),this.transmitter.resolve(i),this.hasConnected=!0}setRouter(e){this.router.resolve(e)}setTransmitter(e){this.transmitter.resolve(e)}addInterceptor(e){return C(this,void 0,void 0,(function*(){(yield this.transmitter.promise).addInterceptor(e)}))}send(e,t={}){return C(this,void 0,void 0,(function*(){return(yield this.transmitter.promise).send(e,t)}))}use(e){return C(this,void 0,void 0,(function*(){(yield this.router.promise).use(e)}))}on(e,...t){return C(this,void 0,void 0,(function*(){(yield this.router.promise).on(e,...t)}))}close(){return C(this,void 0,void 0,(function*(){(yield this.router.promise).close()}))}}const b=(e,t)=>{!e.hasSent()&&t&&(e.sendError(t),((e,t)=>{e.setContext("ERROR_SENT",!0)})(e))},O="RoktRecogniser",A="CTRL_LOAD_COMPLETE",N="SELECT_PLACEMENTS_END",L=e=>t=>{t.isResponse||(t.headers=Object.assign(Object.assign({},t.headers),{host:e.location.host,origin:e.location.origin,href:e.location.href,pathname:e.location.pathname}))},D=e=>e.send(),x="original-sender-alias";const G=(e,t)=>i=>{return s=void 0,n=void 0,o=function*(){try{const s=i.getHeaders(),n=l,r=s[n],o=d,a=s[o],c=function(e,t){var i={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(i[s[n]]=e[s[n]])}return i}(s,["symbol"==typeof n?n:n+"","symbol"==typeof o?o:o+""]),h={[x]:r,"original-sender-id":a},u=yield e.send(t||i.getEvent(),{body:i.getBody(),headers:Object.assign(Object.assign({"is-proxied":"true"},h),c)});for(const[e,t]of Object.entries(u.headers))i.setResponseHeader(e,t);i.send(u.body)}catch(e){i.sendError(e)}},new((r=void 0)||(r=Promise))((function(e,t){function i(e){try{c(o.next(e))}catch(e){t(e)}}function a(e){try{c(o.throw(e))}catch(e){t(e)}}function c(t){var s;t.done?e(t.value):(s=t.value,s instanceof r?s:new r((function(e){e(s)}))).then(i,a)}c((o=o.apply(s,n||[])).next())}));var s,n,r,o};class k{constructor(e,t){this.type=e,this.payload=t}}const U="LINK_SENDING_DATA",M="LINK_CLIENT_READY_FOR_PORT",j="LINK_HOST_PORT_TRANSFER",F="LINK_LISTENING";class H{constructor(e){this.port=e,this.onEvent=m(this.port,"message");const t=n(this.onEvent)(o((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.type)===F})));var i;this.onReady=S(t).then((()=>{})),this.onMessage=n(this.onEvent)(r((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.type)===U})),(i=e=>e.data.payload,e=>{const t=i(e.value);return new s(t)})),this.port.start()}send(e){this.dispatch(e)}dispatch(e){return t=this,i=void 0,n=function*(){yield this.onReady;const t=new k(U,e);this.port.postMessage(t)},new((s=void 0)||(s=Promise))((function(e,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(o,a)}c((n=n.apply(t,i||[])).next())}));var t,i,s,n}}var K=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};const B="none";class q{constructor(e){this.window=e}getCookie(e){try{const t=this.window.document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));if(t)return t[2]}catch(e){}}setCookie(e){try{this.window.document.cookie=this.serialize(e)}catch(e){}}serialize(e){const{name:t,path:i="/",sameSite:s,secure:n,value:r}=e;let{expires:o}=e;if(!o){const e=new Date;e.setTime(e.getTime()+31536e6),o=e}let a=`${t}=${r};expires=${o.toUTCString()};path=${i}`;return n&&(a+=";secure"),s&&(a+=`;samesite=${s}`),a}}const V=()=>{if("undefined"==typeof window)throw new Error("NO_WINDOW");return window};class W{constructor(e,t="local"){this.window=e,this._store="session"===t?"sessionStorage":"localStorage"}getItem(e){try{const t=this.window[this._store].getItem(e);if(null===t)return;return t}catch(e){return}}setItem(e,t){try{this.window[this._store].setItem(e,t)}catch(e){}}}class $ extends W{constructor(e){super(e,"local")}}class X extends W{constructor(e){super(e,"session")}}var z=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};class Y{constructor(e){this.options=e,this.onConnectionSubject=new _,this.connections={},this.handshakeFilter=e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.type)===M&&e.data.payload.ID===(this.options.ID||80)},this.handshake=e=>z(this,void 0,void 0,(function*(){const t=a(20),i=new this.options.channelConstructor,{port1:s,port2:n}=i,r=new H(s);e.source&&(e.source.postMessage(new k(j),this.options.targetOrigin,[n]),yield r.onReady,this.connections[t]=r,this.onConnectionSubject.next(r),s.postMessage(new k(F)))})),this.onConnection=this.onConnectionSubject.asObservable();const t=m(this.options.selfEventSource,"message");this.onPostMessage=n(t)(r(this.handshakeFilter)).subscribe(this.handshake)}destroy(){this.onPostMessage.unsubscribe()}connect(e){return z(this,void 0,void 0,(function*(){const t=yield(({target:e,targetID:t=80,targetOrigin:i="*",selfEventSource:s,retryTimeout:r=1e3})=>K(void 0,void 0,void 0,(function*(){const a=m(s,"message"),l=n(a)(o((e=>{var t;return(null===(t=e.data)||void 0===t?void 0:t.type)===j}))),d=S(l);let h;setTimeout((()=>K(void 0,void 0,void 0,(function*(){for(;void 0===h;)e.postMessage(new k(M,{ID:t}),i),yield c(r)}))),0);const u=yield d;h=u.ports[0];const g=new H(h);return h.postMessage(new k(F)),g})))({target:e.target,targetOrigin:this.options.targetOrigin||"*",selfEventSource:this.options.selfEventSource});return this.onConnectionSubject.next(t),t}))}}const J=({targetOrigin:e,ID:t=80,window:i=V()})=>new Y({targetOrigin:e,ID:t,selfEventSource:i,channelConstructor:i.MessageChannel}),Q="ROKT_FRAME_ECHO_MESSAGE";class Z{constructor(e){this.type=Q,this.name=e.name,this.id=e.id,this.origin=e.location.origin,this.host=e.location.host}}class ee{constructor(e,t){this.window=e,this.validatorService=t,this.onEvent=e=>{var t;if(!this.validatorService.verify(e.origin))return;const i=e.data;(null==i?void 0:i.type)===Q&&(null===(t=e.source)||void 0===t||t.postMessage(new Z(this.window),e.origin))},this.window.addEventListener("message",this.onEvent)}remove(){this.window.removeEventListener("message",this.onEvent)}}class te{constructor(e,t,i,s){this.headers=e,this.status=t,this.statusText=i,this.url=s}}const ie="GET",se="POST";class ne{constructor(e){this.window=e}request(e){return t=this,i=void 0,n=function*(){const t=yield this.window.fetch(...(e=>{const t=e.method||"GET";return!(e.headers&&e.headers["Content-Type"])&&e.body&&"object"==typeof e.body&&(e.body=JSON.stringify(e.body),e.headers=Object.assign({"Content-Type":"application/json"},e.headers||{})),[e.url,{method:t,headers:e.headers,body:e.body}]})(e)),i=(e=>{const t={};return e.forEach(((e,i)=>t[i.toLowerCase()]=e)),t})(t.headers);if(!1===t.ok)throw new te(i,t.status,t.statusText,t.url);const s=yield(e=>{return t=void 0,i=void 0,n=function*(){let t;return t=(e.headers.get("Content-Type")||"").includes("json")?yield e.json():yield e.text(),t},new((s=void 0)||(s=Promise))((function(e,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(o,a)}c((n=n.apply(t,i||[])).next())}));var t,i,s,n})(t);return{body:s,headers:i,status:t.status,statusText:t.statusText}},new((s=void 0)||(s=Promise))((function(e,r){function o(e){try{c(n.next(e))}catch(e){r(e)}}function a(e){try{c(n.throw(e))}catch(e){r(e)}}function c(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(o,a)}c((n=n.apply(t,i||[])).next())}));var t,i,s,n}get(e,t){return this.request({url:e,method:ie,headers:t})}post(e,t={},i){return this.request({url:e,method:se,body:t,headers:i})}}const re="RoktRecogniser";class oe{constructor(e,t,i){this.cookieService=e,this.localStorageService=t,this.sameSite=i}setRecogniser(e){e.cookie&&this.cookieService.setCookie({name:re,sameSite:this.sameSite,secure:!0,value:e.cookie}),e.localStorage&&this.localStorageService.setItem(re,e.localStorage)}getRecogniser(){return{cookie:this.cookieService.getCookie(re),localStorage:this.localStorageService.getItem(re)}}}class ae extends oe{constructor(e,t){super(e,t,B)}}const ce=/^((:?\/\/|https?:)?(?:\/\/)?(?:[^/]*@)?([a-zA-z\d-\.\*]+?)(:\d{2,5})?)([/][^\?]*?)?([?].*)?$/;class le{constructor(e){this.whitelist=e}verify(e){return this.whitelist.some((t=>this._matchOrigin(t,e)))}_parseOrigin(e){const t=function(e){var t;const i=null!==(t=ce.exec(e))&&void 0!==t?t:[];return{origin:i[1],protocol:i[2],hostname:i[3],port:i[4],pathname:i[5],search:i[6]}}(null==e?void 0:e.trim().toLowerCase());if(!t||!t.hostname)return null;const{protocol:i,hostname:s,port:n}=t;return[i,s,n]}_matchHostname(e,t){if(!e||!t)return!1;const i=e.split("."),s=t.split(".");for(;i.length>0;){const e=i.pop(),t=s.pop();if("*"===e)return!0;if(e!==t)return!1}return!(s.length>0)}_matchOrigin(e,t){const i=this._parseOrigin(e),s=this._parseOrigin(t);if(null===i||null===s)return!1;const[n,r,o]=i,[a,c,l]=s;return n===a&&this._matchHostname(r,c)&&o===l}}const de="preload",he="[L] CLOSE_PLACEMENT",ue="[L] FAILED_TO_LOAD_PLUGIN",ge="PAGE_START",pe="ROKT_START",ve="PLUGIN_RUNTIME_FRAME_CREATED",_e="SELECTION_START",Se="SELECTION_END",me="ERROR",Ie="WARNING";class fe extends Error{constructor(e,t){var i,s;super(e),this.name=null!==(i=null==t?void 0:t.name)&&void 0!==i?i:this.name,this.code=null==t?void 0:t.code,this.additionalInformation=null==t?void 0:t.additionalInformation,this.handled=null!==(s=null==t?void 0:t.handled)&&void 0!==s&&s,this.severity=(null==t?void 0:t.severity)||me}}class ye{constructor(e){var t,i,s,n,r;this.userAgent=e.navigator.userAgent,this.flocPromise=this._getFloc(e);const o=new URLSearchParams(e.name),a={initTimestamp:o.get("initTimestamp"),launcherInstanceId:o.get("launcherInstanceId"),tagId:o.get("tagId"),url:o.get("url"),sessionRecogniser:o.get("sessionRecogniser")},c=Object.keys(a).filter((e=>!a[e]&&"0"!==a[e]||"undefined"===a[e]));if(c.length)throw new fe(`Missing required parameters: ${c.join(", ")}`,{code:"CONTROLLER_CONFIGURATION",severity:me});this.initTimestamp=a.initTimestamp,this.launcherInstanceId=a.launcherInstanceId,this.tagId=a.tagId,this.url=a.url,this.sessionRecogniser=JSON.parse(a.sessionRecogniser),this.noDeviceId="true"===o.get("noDeviceId"),this.noFunctional="true"===o.get("noFunctional"),this.noTargeting="true"===o.get("noTargeting"),this.doNotShareOrSell="true"===o.get("doNotShareOrSell"),this.sandbox="true"===o.get("sandbox"),this.integration=null!==(t=o.get("integration"))&&void 0!==t?t:"unknown",this.integrationType=null!==(i=o.get("integrationType"))&&void 0!==i?i:"default",this.launcherVersion=null!==(s=o.get("launcherVersion"))&&void 0!==s?s:"0.0.1",this.sessionId=null!==(n=o.get("sessionId"))&&void 0!==n?n:void 0,this.serviceUrlOverride=null!==(r=o.get("serviceUrlOverride"))&&void 0!==r?r:void 0;const l=o.get("customHeaders");null!==l&&"undefined"!==l&&(this.customHeaders=JSON.parse(l))}async _getFloc(e){let t;if("function"==typeof e.document.interestCohort)try{t=await e.document.interestCohort()}catch(e){}return t}}class we{constructor(e){this._featureList=e.FEATURE_FLAGS.split(",")}isEnabled(e){return this._featureList.includes(e)}isDisabled(e){return!this.isEnabled(e)}}class Ee extends P{}class Te{constructor(e){this._launcherConnection=e}async send(e,t){try{await this._launcherConnection.send("[L] SEND_LAUNCHER_EVENT",{body:{name:e,payload:t}})}catch(e){}}}class Re{constructor(e,t,i){this._configSet=e,this._lifecycleRdnService=t,this._hasSignaledInit=!1,this._initTimestamp=null,this._startSelectionTimestamp=null,this._initTimestamp=new Date(i.initTimestamp)}setInitTimestamp(e){this._initTimestamp=e}onStartSelection(){this._startSelectionTimestamp=new Date}onCompleteSelection(){const e=this._configSet.getPageContext().pageInstanceGuid;e&&(this._hasSignaledInit||(this._lifecycleRdnService.pageInitialized(e,this._initTimestamp),this._hasSignaledInit=!0),this._lifecycleRdnService.pageLoadStarted(e,this._startSelectionTimestamp),this._lifecycleRdnService.pageLoadCompleted(e))}}class Ce{constructor(...e){this.stores=e}add(e){this.stores.forEach((t=>t.add(e)))}}class Pe{constructor(e,t){this._metricsStore=e,this._sessionDetailsService=t,this.launcherInststanceId=new R}async trigger(e){this._sessionDetailsService.getIntegrationType()!==de&&(this.launcherInststanceId.isFulfilled()||this.launcherInststanceId.resolve(e.launcherInstanceId),this._metricsStore.add(e))}async triggerLoadComplete(){return this._triggerControllerEvent(A)}async triggerControllerStart(e){return this._triggerControllerEvent("CONTROLLER_START",e)}async triggerSelectionStart(e){return this._triggerControllerEvent("SELECT_PLACEMENTS_START",new Date,e)}async triggerSelectionEnd(e){return this._triggerControllerEvent(N,new Date,e)}async _triggerControllerEvent(e,t=new Date,i){return this.trigger({type:e,launcherInstanceId:await this.launcherInststanceId.promise,pageInstanceId:i,timestamp:t.toISOString()})}}const be="PLUGIN_IS_INTERACTIVE",Oe="PLUGIN_START",Ae="INTERNAL_PLUGIN_FRAME_CREATED",Ne="plugin-instance-id",Le=e=>e.getHeaders()["plugin-instance-id"];class De{constructor(e,t,i){this._configSet=e,this._errorService=t,this._metricRepository=i,this._selectionEvents=new Map,this._pluginEvents=new Map,this._pluginSelectionIndex=new Map,this._pluginNameIndex=new Map}async add(e){var t;const i=new Date(e.timestamp).getTime();if(e.type!==ge||this._pageStart){if("INTEGRATION_START"===e.type&&!this._integrationStart)return this._integrationStart=i,void(this._integrationName=null===(t=e.data)||void 0===t?void 0:t.integrationName);if("LAUNCHER_START"!==e.type||this._launcherStart)if(e.type!==A||this._controllerLoadComplete)if(e.type===_e&&e.pageInstanceId)this._setSelectionEvent(e.pageInstanceId,e.type,i);else if(e.type!==N)if(e.type===Se&&e.pageInstanceId)this._setSelectionEvent(e.pageInstanceId,e.type,i);else if(e.type===ve&&e.pluginInstanceId)this._setPluginEvent(e.pluginInstanceId,e.type,i);else if(e.type===Ae&&e.pluginInstanceId)this._setPluginEvent(e.pluginInstanceId,e.type,i);else{if(e.type!==Oe||!e.pluginInstanceId)return e.type===be&&e.pluginInstanceId?(this._setPluginEvent(e.pluginInstanceId,e.type,i),void this._report(e.pluginInstanceId)):void 0;this._setPluginEvent(e.pluginInstanceId,e.type,i)}else for(const{pluginInstanceId:e,pageInstanceId:t,plugin:i}of this._configSet.list())this._firstSelectionId||(this._firstSelectionId=t),this._pluginNameIndex.set(e,i.name),this._pluginSelectionIndex.set(e,t);else this._controllerLoadComplete=i;else this._launcherStart=i}else this._pageStart=i}_setSelectionEvent(e,t,i){const s=this._selectionEvents.get(e)||new Map;s.set(t,i),this._selectionEvents.set(e,s)}_setPluginEvent(e,t,i){const s=this._pluginEvents.get(e)||new Map;s.set(t,i),this._pluginEvents.set(e,s)}async _report(e){var t;const i=this._pluginNameIndex.get(e);try{const t=this._pluginSelectionIndex.get(e),s=this._calculateEntries(t,e);this._validateEntries(i,s);const n=this._calculateRawMetrics(s,t);this._validateRawMetrics(n);const r=[];for(const[e,t]of Object.entries(n))r.push({metricName:e,value:t,integration:this._integrationName,pluginAlias:i});await this._metricRepository.submit(...r)}catch(e){const s=null!==(t=e.additionalInformation)&&void 0!==t?t:{},n=new fe("",{code:"METRICS_CALCULATION_FAILURE",severity:Ie,additionalInformation:Object.assign({integrationName:this._integrationName,pluginAlias:i},s)});this._errorService.reportError(n)}}_calculateEntries(e,t){const i=e?this._selectionEvents.get(e):void 0,s=this._pluginEvents.get(t);return{controllerLoadComplete:this._controllerLoadComplete,launcherStart:this._launcherStart,integrationStart:this._integrationStart,pageStart:this._pageStart,selectionStart:null==i?void 0:i.get(_e),selectionEnd:null==i?void 0:i.get(Se),pluginRuntimeFrameCreated:null==s?void 0:s.get(ve),pluginFrameCreated:null==s?void 0:s.get(Ae),pluginBootstrap:null==s?void 0:s.get(Oe),pluginInteractive:null==s?void 0:s.get(be)}}_calculateRawMetrics(e,t){const i={integration:e.launcherStart-e.integrationStart,framework:e.controllerLoadComplete-e.launcherStart,selection:e.selectionEnd-e.selectionStart,pluginRuntime:e.pluginFrameCreated-e.pluginRuntimeFrameCreated,pluginBootstrap:e.pluginBootstrap-e.pluginFrameCreated,pluginInteractive:e.pluginInteractive-e.pluginBootstrap};return i.RTTI=i.integration+i.framework+i.selection+i.pluginRuntime+i.pluginInteractive+i.pluginBootstrap,e.pageStart&&(i.timeToFirstTouch=e.integrationStart-e.pageStart,i.TTI=i.RTTI+i.timeToFirstTouch),this._firstSelectionId===t&&(e.pageStart&&(i.DTTI=e.pluginInteractive-e.pageStart),i.DRTTI=e.pluginInteractive-e.integrationStart),i}_validateEntries(e,t){const i=Object.entries(t).reduce(((e,[t,i])=>i||"pageStart"===t?e:e.concat(t)),[]);if(!this._integrationName||!e||i.length)throw new fe("",{additionalInformation:{missingMetrics:i.join(",")}})}_validateRawMetrics(e){const t=Object.entries(e).reduce(((e,[t,i])=>i<0?e.concat(t):e),[]);if(!this._integrationName||t.length)throw new fe("",{additionalInformation:{invalidMetrics:t.join(",")}})}}class xe{constructor(e){this._httpService=e}async submit(...e){if(!e.length)return;const t=e;await this._httpService.request({url:"/v2/metrics",method:se,body:t})}}class Ge{constructor(){this.pagesInstanceGuids={}}getPageInstanceGuid(e){return this.pagesInstanceGuids[e]||this.createEntry(e),this.pagesInstanceGuids[e].promise}setPageInstanceGuid(e,t){this.pagesInstanceGuids[e]||this.createEntry(e),this.pagesInstanceGuids[e].resolve(t)}createEntry(e){this.pagesInstanceGuids[e]=new R}}class ke{constructor(e,t,i,s,n){this._pageContextPromise=new R,this._errorService=e,this._sessionDetailsService=t,this._config=i,this._windowRef=s,this._launcherConnection=n,this._data={},this._settings={},this._relations={},this._loadingTimeout=5e3}add(e,t){var i;const s=Object.assign(Object.assign({pluginInstanceId:e},t),{plugin:Object.assign(Object.assign({},t.plugin),{name:t.plugin.name||""})});s.plugin.config||(s.plugin.config={}),s.loaded=null!==(i=s.loaded)&&void 0!==i&&i,!s.plugin.name&&s.plugin.url&&(s.plugin.name=(e=>{try{return e.split("/plugins/")[1].split("/")[0]}catch(t){return"[no-alias]"+e}})(s.plugin.url)),this._data[e]=s,this._relations[e]={parentInstanceId:void 0,children:[]}}get(e){return this._data[e]}list(){return Object.values(this._data)}getPageContext(){return this._pageContext}getPageContextAsync(){return this._pageContextPromise.promise}setPageContext(e){this._pageContextPromise.isFulfilled()&&(this._pageContextPromise=new R),this._pageContextPromise.resolve(e),this._pageContext=e}getDisplaySettings(e){return this._settings[e]}setDisplaySettings(e,t){this._settings[e]=t}getRelations(e){return this._relations[e]}triggerPluginLoading(e){if(this._data[e]&&!this._data[e].loaded){const t=()=>this.reportPluginLoadFailure(e);this._data[e].loadingRef=this._windowRef.setTimeout(t,this._loadingTimeout)}}triggerPluginLoaded(e){this._data[e]&&(this._data[e].loaded=!0,this._windowRef.clearTimeout(this._data[e].loadingRef))}generatePluginConfiguration(e){var t,i,s;const n=this._data[e];if(!n)throw new Error("Unknown placement");const r=new URLSearchParams;r.append("init_timestamp",(new Date).getTime().toString()),r.append("plugin_instance_id",e),r.append("launcher_instance_id",this._sessionDetailsService.getLauncherInstanceId()),r.append("rokt_tag_id",this._sessionDetailsService.getTagId()),r.append("rokt_session_id",this._sessionDetailsService.getSessionId()),r.append("page_instance_id",n.pageInstanceId),r.append("integration_type","plugin"),r.append("selection_instance_id",""),r.append("language",null!==(i=null===(t=this._pageContext)||void 0===t?void 0:t.language)&&void 0!==i?i:""),r.append("sandbox",this._config.sandbox?"true":"false");const o=null===(s=this.getRelations(e))||void 0===s?void 0:s.parentInstanceId;return o&&(r.append("parent_instance_id",o),r.append("child_plugin","true")),r.append("alias",n.plugin.id),r.toString()}reportPluginLoadFailure(e){this._errorService.reportError(new fe(`Plugin container frame failed to load within ${this._loadingTimeout}ms.`,{code:"PLUGIN_CONTAINER_LOAD",severity:me,additionalInformation:{pluginInstanceId:e}})),this._launcherConnection.send(ue,{headers:{[Ne]:e}})}}class Ue{constructor(){this.connections={}}add(e,t){this.connections[e]?this.connections[e].resolve(t):this.connections[e]=R.resolve(t)}get(e){const t=this.connections[e]||new R;return this.connections[e]=t,t.promise}remove(e){const t=this.connections[e];t&&t.isPending()&&t.reject(new Error("Removed before connected")),delete this.connections[e]}}const Me="rokt-session-id",je="rokt-account-id",Fe="rokt-do-not-track",He="rokt-third-party-cookie",Ke="rokt-third-party-local-storage",Be="rokt-existing-test-session",qe="SignalLoadStart",Ve="SignalLoadComplete",We={ERROR:"ERROR_LIMIT_EXCEEDED",WARNING:"WARNING_LIMIT_EXCEEDED"};class $e{constructor(e,t){var i;this._loggingService=t,this.limits={[me]:10,[Ie]:10},this.counts={[me]:0,[Ie]:0},this.limitSent={[me]:!1,[Ie]:!1},null===(i=e.roktReporter)||void 0===i||i.set((e=>this._reportGlobalError(e)))}async reportError(e,t=!1){e.severity=e.severity||me,t||!this._checkLimit(e.severity)?await this._loggingService.error({severity:e.severity,stackTrace:e.stack,additionalInformation:Object.assign(Object.assign({},e.additionalInformation),{message:e.message}),reporter:e.reporter,integration:e.integration,code:e.code||"UNHANDLED_EXCEPTION"}):await this._reportLimitExceeded(e)}async _reportGlobalError(e){if(null==e?void 0:e.handled)return;const{name:t,message:i,additionalInformation:s,stack:n,code:r}=e,o={code:null!=r?r:"UNHANDLED_EXCEPTION",name:t,message:i,severity:e.severity||Ie,stack:n,additionalInformation:null!=s?s:{}};try{await this.reportError(o)}catch(e){}}_checkLimit(e){return!!(this.limits[e]&&(this.counts[e]+=1,this.counts[e]>this.limits[e]))}async _reportLimitExceeded(e){this.limitSent[e.severity]||(e.code=We[e.severity],this.limitSent[e.severity]=!0,await this.reportError(e,!0))}}var Xe=function(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((s=s.apply(e,t||[])).next())}))};class ze{constructor(e,t,i){this._conn=e,this._transmitter=t,this._iframe=i}destroy(){var e;this._conn.destroy(),null===(e=this._iframe.parentElement)||void 0===e||e.removeChild(this._iframe)}getCookies(e){return Xe(this,void 0,void 0,(function*(){return(yield this._transmitter.send("GET_COOKIE",{body:e})).body}))}setCookies(e){return Xe(this,void 0,void 0,(function*(){const t={values:e};return(yield this._transmitter.send("SET_COOKIE",{body:t})).body}))}getLocalStorage(e){return Xe(this,void 0,void 0,(function*(){return(yield this._transmitter.send("GET_LOCAL_STORAGE",{body:e})).body}))}setLocalStorage(e){return Xe(this,void 0,void 0,(function*(){const t={values:e};return(yield this._transmitter.send("SET_LOCAL_STORAGE",{body:t})).body}))}}class Ye{constructor(e,t){this.window=e,this.constants=t}async getRecogniser(){try{return await this.tryGetSession()}catch(e){return{cookie:void 0,localStorage:void 0}}}async setRecogniser(e){const t=await this.getTransferClient(),i=[];if(e.cookie){const s=t.setCookies({[O]:{sameSite:B,secure:!0,value:e.cookie}});i.push(s)}if(e.localStorage){const s=t.setLocalStorage({[O]:e.localStorage});i.push(s)}await Promise.all(i)}destroy(){this.transferClient&&(this.transferClient.destroy(),this.transferClient=void 0)}async getTransferClient(){if(!this.transferClient){const i=this.constants.ORIGIN_ROKT_APPS+"/session-transfer";this.transferClient=await(e=i,t=this.window,Xe(void 0,void 0,void 0,(function*(){const i=t.document.createElement("iframe");i.src=e,i.style.display="none",i.sandbox.add("allow-scripts"),i.sandbox.add("allow-same-origin");const s=new Promise((e=>i.onload=e));t.document.body.appendChild(i),yield s;const n=J({targetOrigin:"*",window:t}),r=yield n.connect({target:i.contentWindow}),o=new v({connection:r});return o.addInterceptor(L(window)),new ze(n,o,i)})))}var e,t;return this.transferClient}async tryGetSession(){const e=await this.getTransferClient(),[t,i]=await Promise.all([this.extractRecogniser((t=>e.getCookies(t))),this.extractRecogniser((t=>e.getLocalStorage(t)))]);return{cookie:t,localStorage:i}}async extractRecogniser(e){try{const t={keys:[O]};return(await e(t)).RoktRecogniser}catch(e){return}}}function Je(e,t=3,i=100,s=(()=>!0)){return n=this,r=void 0,a=function*(){try{return yield e()}catch(e){if(t<=1||!s(e))throw e}return yield c(1*i),yield Je(e,t-1,i)},new((o=void 0)||(o=Promise))((function(e,t){function i(e){try{c(a.next(e))}catch(e){t(e)}}function s(e){try{c(a.throw(e))}catch(e){t(e)}}function c(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o((function(e){e(n)}))).then(i,s)}c((a=a.apply(n,r||[])).next())}));var n,r,o,a}class Qe{constructor(e,t,i,s,n){this.window=e,this.constants=t,this.widgetApiService=i,this.sessionDetailsService=s,this.placementConfigSet=n}async process(){if(this.window.location.origin===this.constants.ORIGIN_ROKT_APPS||this.sessionDetailsService.getDoNotTrack())return;const e=new Ye(this.window,this.constants),t=await e.getRecogniser(),i=await this.sessionRequest(t);await e.setRecogniser(i),e.destroy()}async sessionRequest(e){const t=this.createHeaders(e),{headers:i}=await Je((()=>this.widgetApiService.get("/v1/session/legacy",t)));return{cookie:i["rokt-third-party-cookie"],localStorage:i["rokt-third-party-local-storage"]}}createHeaders({cookie:e,localStorage:t}){var i;const s=null===(i=this.placementConfigSet.getPageContext())||void 0===i?void 0:i.pageInstanceGuid;return((e,t)=>{const i={};for(const s of Object.keys(e)){const n=e[s];t(0,n)&&(i[s]=n)}return i})({[He]:e,[Ke]:t,"rokt-page-instance-guid":s},((e,t)=>void 0!==t))}}class Ze{constructor(e){this.rdnService=e}pageInitialized(e,t){this.rdnService.triggerEvent({eventType:"SignalInitialize",parentGuid:e},{clientTimeStamp:t})}pageLoadStarted(e,t){this.rdnService.triggerEvent({eventType:qe,parentGuid:e},{clientTimeStamp:t})}pageLoadCompleted(e){this.rdnService.triggerEvent({eventType:Ve,parentGuid:e})}placementLoadStarted(e){this.rdnService.triggerEvent({eventType:qe,parentGuid:e})}placementLoadCompleted(e){this.rdnService.triggerEvent({eventType:Ve,parentGuid:e})}}class et{constructor(e,t,i){this._sessionDetailsService=e,this._widgetAPIService=t,this._config=i}async log(e){var t,i;if(this._sessionDetailsService.getIntegrationType()===de)return;const s=Object.assign(Object.assign({severity:"INFO"},e),{integration:null!==(t=e.integration)&&void 0!==t?t:this._config.integration,reporter:null!==(i=e.reporter)&&void 0!==i?i:"WSDK"});await this._widgetAPIService.request({url:"/v1/log",method:se,body:s})}async error(e){var t,i;let s="";try{const e=this._sessionDetailsService.getHref();s=new URL(e).origin}catch(e){}const n=Object.assign(Object.assign({},e),{reporter:null!==(t=e.reporter)&&void 0!==t?t:"WSDK",integration:null!==(i=e.integration)&&void 0!==i?i:this._config.integration,deviceInfo:this._sessionDetailsService.getUserAgent(),url:s});await this._widgetAPIService.request({url:"/v1/errors",method:se,body:n})}}const tt=e=>Array.isArray(e)?e.filter(((t,i)=>e.indexOf(t)===i&&it(t))).join(","):it(e)?e.toString():"";function it(e){return null!=e&&""!==e}class st{constructor(e,t,i,s,n,r){this._widgetApiService=e,this._recogniserService=t,this._config=i,this._launcherEventService=s,this._sessionDetailsService=n,this._loggingService=r,this._selectionCount=0}async selectPlacements(e){this._selectionCount++;const t=this._selectionCount;this._sessionDetailsService.incrementSessionIdSelectionCount();const i=await this._recogniserService.getRecogniserHeaders(),s=await this._prepareSelectPlacementsBody(e);let n;try{const e=await Je((()=>this._widgetApiService.request({url:"/v2/placements",method:se,allowStaleSession:!1,body:s,headers:i})),3,100,(e=>!(e instanceof te)||!e.status||e.status<400||408===e.status));n=e.body,this._verifyResponseBody(n),this._setSessionInformation(e.headers)}catch(e){throw e.code||(e.code="PLACEMENTS_RESPONSE"),e.severity=Ie,e}if(this._selectionCount!==t)throw new fe("Simultaneous selection response ignored.",{severity:Ie,code:"SIMULTANEOUS_SELECTION"});return this._launcherEventService.send("PAGE_ID_UPDATED",n.pageContext.pageId),this._launcherEventService.send("PAGE_INSTANCE_GUID_UPDATED",n.pageContext.pageInstanceGuid),this._launcherEventService.send("PAGE_VARIANT_NAME_UPDATED",n.pageContext.pageVariantName),n}async _prepareSelectPlacementsBody(e){const t={},i=await this._config.flocPromise,s=[],n=[];i&&(t.floc=i);const r={noFunctional:this._sessionDetailsService.getNoFunctional()||void 0,noTargeting:this._sessionDetailsService.getNoTargeting()||void 0,doNotShareOrSell:this._sessionDetailsService.getDoNotShareOrSell()||void 0,gpcEnabled:this._sessionDetailsService.getGlobalPrivacyControl()||void 0};for(const[i,{value:r}]of Object.entries(e.attributes)){const e=tt(r);e&&(t[i]=e),this._isComplexAttribute(r)?s.push(i):this._isArrayWithPrimitive(r)&&n.push(i)}return this._randomlyLogAttributeCollections(s,n),Object.assign(Object.assign({},e),{privacyControl:r,attributes:t})}_randomlyLogAttributeCollections(e,t){Math.random()<.05&&(e.length&&this._loggingService.log({code:"ATTRIBUTES_WITH_COMPLEX_VALUES",additionalInformation:{attributes:JSON.stringify(e)}}),t.length&&this._loggingService.log({code:"ATTRIBUTES_WITH_ARRAY_OF_PRIMITIVES",additionalInformation:{attributes:JSON.stringify(t)}}))}_isArrayWithPrimitive(e){return!!Array.isArray(e)&&e.some((e=>"object"!=typeof e&&null!==e||this._isArrayWithPrimitive(e)))}_isComplexAttribute(e){return"object"==typeof e&&null!==e&&(!Array.isArray(e)||e.some((e=>this._isComplexAttribute(e))))}_verifyResponseBody(e){if(!e.pageContext||!e.placements){const t=new fe("Unexpected placements response.");throw e.description&&e.description.match(/quota exceeded/i)&&(t.code="SANDBOX_EXCEEDED"),t}}_setSessionInformation(e){const t=e["rokt-account-id"];t&&this._sessionDetailsService.setAccountId(t);const i=e["rokt-session-id"],s="true"===e["rokt-existing-test-session"];i&&this._sessionDetailsService.setSessionId(i,{isTestSession:s}),this._launcherEventService.send("SESSION_ID_UPDATED",i)}}function nt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{return(("y"===e?8:0)^(t=new Uint8Array(1),(window.crypto||window.msCrypto).getRandomValues(t))[0]&15>>("y"===e?2:0)).toString(16);var t}))}const rt="RoktEtag";class ot{constructor(e,t,i,s,n,r,o,a,c){this.apiService=e,this.recogniserAccessor=t,this.storageService=i,this.launcherConnection=s,this.errorService=n,this.sessionDetailsService=a,this._roktEtagPromise=new R,this._etagRequestInProgress=!1,r.location.href.includes(o.ORIGIN_ROKT_APPS)?(this._thirdPartyCookieKey=He,this._thirdPartyLocalKey=Ke):(this._thirdPartyCookieKey="rokt-wsdk-third-party-cookie",this._thirdPartyLocalKey="rokt-wsdk-third-party-local-storage"),this.storeFirstPartyRecognisers(c.sessionRecogniser),this.storeThirdPartyRecognisers()}async getSessionEtag(){if(!this.sessionDetailsService.getNoTargeting()){if(this._etagRequestInProgress||this._roktEtagPromise.isFulfilled())return this._roktEtagPromise.promise;{this._etagRequestInProgress=!0;const e=this.storageService.getItem(rt)||await this._requestETag();return this._roktEtagPromise.resolve(e),this._etagRequestInProgress=!1,e?(this.storageService.setItem(rt,e),e):void 0}}}async storeFirstPartyRecognisers(e){if(!this.sessionDetailsService.getNoFunctional()){this._firstPartyRecogniser=this._defaultRecognisers(e);try{await this.launcherConnection.send("[L] SET_FIRST_PARTY_RECOGNISER",{body:{firstPartyRecogniser:this._firstPartyRecogniser}})}catch(e){if(e.code!==h)throw e}}}async storeThirdPartyRecognisers(){this.sessionDetailsService.getNoTargeting()||(this._thirdPartyRecogniser=this._defaultRecognisers(this.recogniserAccessor.getRecogniser()),await this.sessionDetailsService.getLimitedUseAsync()||this.recogniserAccessor.setRecogniser(this._thirdPartyRecogniser))}async getRecogniserHeaders(){var e,t,i,s;if(this.sessionDetailsService.getDoNotTrack())return{[Fe]:"true"};const n={"rokt-enable-recognition":"true"},r=await this.getSessionEtag();r&&!this.sessionDetailsService.getNoTargeting()&&(n["rokt-etag"]=r);const o=null===(e=this._firstPartyRecogniser)||void 0===e?void 0:e.cookie;o&&(n["rokt-first-party-cookie"]=o);const a=null===(t=this._firstPartyRecogniser)||void 0===t?void 0:t.localStorage;a&&(n["rokt-first-party-local-storage"]=a);const c=null===(i=this._thirdPartyRecogniser)||void 0===i?void 0:i.cookie;c&&(n[this._thirdPartyCookieKey]=c);const l=null===(s=this._thirdPartyRecogniser)||void 0===s?void 0:s.localStorage;return l&&(n[this._thirdPartyLocalKey]=l),n}_defaultRecognisers(e={}){var t,i;return e.cookie=null!==(t=e.cookie)&&void 0!==t?t:nt(),e.localStorage=null!==(i=e.localStorage)&&void 0!==i?i:nt(),e}async _requestETag(){var e,t;try{const i=await Je((()=>this.apiService.simpleGet("/v1/session")));return(null===(e=null==i?void 0:i.headers)||void 0===e?void 0:e.Etag)||(null===(t=null==i?void 0:i.headers)||void 0===t?void 0:t.etag)}catch(e){e.code="SESSION_RESPONSE",e.severity=Ie,this.errorService.reportError(e)}}}const at={[ge]:"PAGE_START",[pe]:"ROKT_START",[be]:"PLACEMENT_INTERACTIVE"};class ct{constructor(e,t,i,s){this.rdnService=e,this.pageInformationService=t,this.placementConfigSet=i,this.sessionDetailsService=s}async add(e){if(e.type!==ge&&e.type!==pe&&e.type!==be)return;const t=await this.sessionDetailsService.getSessionIdAsync();let i;if(e.type===be){if(!e.pluginInstanceId)return;const t=this.placementConfigSet.get(e.pluginInstanceId);i=null==t?void 0:t.plugin.config.instanceGuid}else{if(!e.pageInstanceId)return;i=await this.pageInformationService.getPageInstanceGuid(e.pageInstanceId)}const s=this.placementConfigSet.list().some((t=>t.pageInstanceId===e.pageInstanceId));i&&t&&s&&this.rdnService.triggerMetricEvent({type:at[e.type],clientTimestamp:e.timestamp,instanceGuid:nt(),sessionId:t,parentInstanceGuid:i})}}const lt=(e,t=0,i={isImmediate:!1,useAnimationFrame:!1})=>{let s;const n=!0===i.useAnimationFrame&&"function"==typeof window.requestAnimationFrame;return function(...r){const o=i.isImmediate&&!s;var a;a=()=>{s=void 0,i.isImmediate||e(...r)},s=n?(s&&window.cancelAnimationFrame(s),window.requestAnimationFrame(a)):(s&&clearTimeout(s),setTimeout(a,t)),o&&e(...r)}};class dt{constructor(e,t,i){this.widgetApiService=e,this.sessionDetailsService=t,this.errorService=i,this.scheduledEvents=[],this.scheduledMetricEvents=[],this.recordedImpressions={},this.scheduleEvent=((e,t=0,i={isImmediate:!1,useAnimationFrame:!1})=>{let s=new R;const n=lt(((...t)=>{try{null==s||s.resolve(e(...t))}catch(e){null==s||s.reject(e)}s=new R}),t,i);return(...e)=>(n(...e),s.promise)})((()=>{const e=this.scheduledEvents.map((({eventData:e,options:t})=>this.createEventPayload(e,t)));return this.scheduledEvents=[],this.widgetApiService.post("/v1/events",e).catch((t=>{if(!(null==t?void 0:t.statusCode))return this.widgetApiService.post("/v1/info",e).catch((t=>{if(!(null==t?void 0:t.statusCode))return this.widgetApiService.post("/v1/responses",e);throw t}));throw t})).then((()=>{})).catch((e=>{throw e.code="EVENT_RESPONSE",e.severity=Ie,this.errorService.reportError(e).catch((()=>{})),e}))}),25),this.scheduleMetricEvent=lt((async()=>{try{const e=this.scheduledMetricEvents;this.scheduledMetricEvents=[],await this.widgetApiService.post("/v1/events/metrics",e)}catch(e){}}),25)}triggerEvent(e,t={clientTimeStamp:new Date}){const i={eventType:e.eventType,parentGuid:e.parentGuid,pageInstanceGuid:e.pageInstanceGuid,instanceGuid:nt(),attributes:e.attributes,metadata:e.metadata,objectData:e.objectData};if("SignalImpression"===e.eventType){if(this.recordedImpressions[e.parentGuid])return Promise.resolve();this.recordedImpressions[e.parentGuid]=!0}return this.scheduledEvents.push({eventData:i,options:t}),this.scheduleEvent()}triggerMetricEvent(e){this.scheduledMetricEvents.push(e),this.scheduleMetricEvent()}createEventPayload(e,t){var i,s;const n=null!==(s=null===(i=e.attributes)||void 0===i?void 0:i.map((e=>({name:e.name,value:e.value.toString()}))))&&void 0!==s?s:[];return Object.assign(Object.assign({},e),{attributes:n,metadata:this.createMetaData(t,e.metadata),sessionId:this.sessionDetailsService.getSessionId()})}createMetaData(e,t=[]){var i;const s=[{name:"clientTimeStamp",value:(null!==(i=e.clientTimeStamp)&&void 0!==i?i:new Date).toISOString()},{name:"captureMethod",value:"ClientProvided"}];return e.transformedTrafficURL&&s.push({name:"transformedTrafficURL",value:e.transformedTrafficURL}),e.performanceMetrics&&Object.entries(e.performanceMetrics).forEach((e=>{s.push({name:e[0],value:e[1]})})),s.push(...t),s}}class ht{constructor(e,t,i,s){if(this._env=t,this._storage=i,this._errorReporter=s,this._accountId="",this._href="",this._launcherInstanceId="",this._noFunctional=!1,this._noTargeting=!1,this._doNotShareOrSell=!1,this._pageIdentifier="",this._sessionId="",this._isTestSession=!1,this._sessionIdPromise=new R,this._tagId="",this._partnerId="",this._userAgent="",this._sessionIdStorageKey="",this._sessionTimestampKey="",this._sessionIdSelectionCountLimit=50,this._limitedUsePromise=new R,this._userAgent=e.userAgent,this._launcherInstanceId=e.launcherInstanceId,this._tagId=e.tagId,this._partnerId=this._tagId.indexOf("_")>=0?this._tagId.substring(0,this._tagId.indexOf("_")):this._tagId,this._href=e.url,e.noDeviceId||this._isEnableForPartners(this._env.NO_DEVICE_ID_PARTNERS)?this._noFunctional=this._noTargeting=!0:(this._noFunctional=e.noFunctional,this._noTargeting=e.noTargeting),this._doNotShareOrSell=e.doNotShareOrSell,this._integrationType=e.integrationType,this._sessionIdStorageKey=`rokt_session_id-${this._partnerId}`,this._sessionTimestampKey=`rokt_session_timestamp-${this._partnerId}`,this._noMultiPageSessions=this._isEnableForPartners(this._env.MULTI_PAGE_SESSION_BLACKLIST),this._globalPrivacyControl=window.navigator.globalPrivacyControl,e.sessionId)this.setSessionId(e.sessionId);else{const e=this._getStoredSession();e&&e.sessionId&&this.setSessionId(e.sessionId,e.options)}}getAccountId(){return this._accountId}setAccountId(e=""){return this._accountId=e}getHref(){return this._href}setHref(e){this._href=e}getIntegrationType(){return this._integrationType}getLauncherInstanceId(){return this._launcherInstanceId}setLauncherInstanceId(e){this._launcherInstanceId=e}getNoFunctional(){return this._noFunctional}getNoTargeting(){return this._noTargeting}getDoNotTrack(){return this.getNoFunctional()&&this.getNoTargeting()}getDoNotShareOrSell(){return this._doNotShareOrSell}getPageIdentifier(){return this._pageIdentifier}setPageIdentifier(e=""){return this._pageIdentifier=e}getSessionId(){return this._sessionId&&this.resetSessionIdTimestamp(),this._sessionId}isTestSession(){return this._isTestSession}getSessionIdAsync(){return this._sessionId&&this.resetSessionIdTimestamp(),this._sessionIdPromise.promise}setSessionId(e,t){return this._sessionIdPromise.isFulfilled()&&(this._sessionIdPromise=new R),this._sessionIdPromise.resolve(e),this._storeSession(e,t),this._isTestSession=!0===(null==t?void 0:t.isTestSession),this._sessionId=e}isSessionStale(){return!!this._noFunctional||!this._noMultiPageSessions&&!this._getStoredSession().sessionId}resetSessionIdTimestamp(){this._storage.setItem(this._sessionTimestampKey,Date.now().toString())}async incrementSessionIdSelectionCount(){if(this._sessionId){const e=1*(this._storage.getItem(this._sessionId)||0)+1;this._storage.setItem(this._sessionId,e+""),e===this._sessionIdSelectionCountLimit&&(await this._errorReporter).reportError(new fe("Session ID usage limit exceeded.",{severity:Ie,code:"SESSION_LIMIT_EXCEEDED"}))}}getTagId(){return this._tagId}getUserAgent(){return this._userAgent}setUserAgent(e){this._userAgent=e}getLimitedUseAsync(){return this._limitedUsePromise.promise}setLimitedUse(e){this._limitedUsePromise.isFulfilled()&&(this._limitedUsePromise=new R),this._limitedUsePromise.resolve(e)}getGlobalPrivacyControl(){return this._globalPrivacyControl}_getStoredSession(){const e=this._storage.getItem(this._sessionIdStorageKey),t=!!e&&"true"===this._storage.getItem(this._testSessionFlagStorageKey(e)),i=this._storage.getItem(this._sessionTimestampKey),s=e&&this._storage.getItem(e)||0;return!this._noFunctional&&!this._noMultiPageSessions&&e&&i&&s<this._sessionIdSelectionCountLimit&&parseInt(i,10)>Date.now()-18e5?{sessionId:e,options:{isTestSession:t}}:{sessionId:""}}_storeSession(e,t){this._noMultiPageSessions||this._noFunctional||(this._storage.setItem(this._sessionIdStorageKey,e),t&&t.isTestSession&&this._storage.setItem(this._testSessionFlagStorageKey(e),"true"),this.resetSessionIdTimestamp())}_isEnableForPartners(e){return e.split(",").filter((e=>!!e)).includes(this._partnerId)}_testSessionFlagStorageKey(e){return`${e}_is_test`}}class ut{constructor(e,t,i,s,n){this._httpClient=i,this._sessionDetailsService=s,this._featuresFlagService=n,this._apiUrl=t.sandbox?e.ORIGIN_ROKT_APPS_SANDBOX:e.ORIGIN_ROKT_APPS,t.serviceUrlOverride&&(this._apiUrl=t.serviceUrlOverride),t.customHeaders&&(this._customHeaders=t.customHeaders)}setApiUrl(e){this._apiUrl=e}async request(e){return e.headers=this._prepareRequestHeaders(e.headers,!1!==e.allowStaleSession),this._sessionDetailsService.resetSessionIdTimestamp(),await this._simpleRequest(e)}post(e,t,i){return this.request({url:e,method:se,body:t,headers:i})}get(e,t){return this.request({url:e,method:ie,headers:t})}simpleGet(e){return this._simpleRequest({url:e,method:ie})}simplePost(e,t){return this._simpleRequest({url:e,method:se,body:t})}async _simpleRequest(e){var{url:t,headers:i}=e,s=function(e,t){var i={};for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&t.indexOf(s)<0&&(i[s]=e[s]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(s=Object.getOwnPropertySymbols(e);n<s.length;n++)t.indexOf(s[n])<0&&Object.prototype.propertyIsEnumerable.call(e,s[n])&&(i[s[n]]=e[s[n]])}return i}(e,["url","headers"]);return this._httpClient.request(Object.assign({url:this._apiUrl+t,headers:this._enrichWithCustomHeaders(i,this._customHeaders)},s))}_prepareRequestHeaders(e,t){const i={};if(this._addHeader(je,this._sessionDetailsService.getAccountId(),i),t||!this._sessionDetailsService.isSessionStale()){const e=this._sessionDetailsService.getSessionId();e&&(this._addHeader(Me,e,i),this._sessionDetailsService.isTestSession()&&this._addHeader(Be,"true",i))}return this._featuresFlagService.isEnabled("no-device-id")&&this._sessionDetailsService.getDoNotTrack()&&this._addHeader(Fe,"true",i),this._addHeader("rokt-page-identifier",this._sessionDetailsService.getPageIdentifier(),i),this._addHeader("rokt-page-url",this._sessionDetailsService.getHref(),i),this._addHeader("rokt-tag-id",this._sessionDetailsService.getTagId(),i),Object.assign(Object.assign({},i),e)}_addHeader(e,t,i){""!==t&&(i[e]=t)}_enrichWithCustomHeaders(e,t){return t?e?Object.assign(Object.assign({},e),t):t:e}}class gt{constructor(){var e;this.window=V(),this.env=(()=>{let e;return e=void 0==={ORIGIN_ROKT_APPS:"https://apps.rokt.com",ORIGIN_ROKT_APPS_SANDBOX:"https://apps-demo.rokt.com",FEATURE_FLAGS:"no-device-id",MULTI_PAGE_SESSION_BLACKLIST:"fcc19e4c9494452d9e8fde05ce5b0026,260,2554873377920922361,2745201443439123936,2745200842143701109,2745207580947400930,2745199502113902350,2745199845711287180,2745202495706113715,2745207061256356434,2745203934520160133,2745204291002445711,2745204909477737795,2745205253075122293,2745204600240091625,2768954163069212781,2806486756987564147,2806482466315226397,2806484768417702792,2806484390460579187,2806483595891628106,2856198770055723711,2856199491610230954,2856198078565987347,2745198819214101523,2901377256164439275,3002366673326196145,2856198770055723711,2806484768417702792,2856199491610230954,2806483595891628106,2768954163069212781,2806484390460579187,2806482466315226397,2806486756987564147,2856198078565987347,3012069034512628447,3056919513968942327,3060975702558142909",NO_DEVICE_ID_PARTNERS:"2074245483568304147,2215307220479662547,2222069010832063954,2388261640774383951,2393374215224752143,2545534615780864385,2695481750969397521,2695486883455316530"}?{ORIGIN_ROKT_APPS:"",ORIGIN_ROKT_APPS_SANDBOX:"",FEATURE_FLAGS:"",MULTI_PAGE_SESSION_BLACKLIST:"",NO_DEVICE_ID_PARTNERS:""}:{ORIGIN_ROKT_APPS:"https://apps.rokt.com",ORIGIN_ROKT_APPS_SANDBOX:"https://apps-demo.rokt.com",FEATURE_FLAGS:"no-device-id",MULTI_PAGE_SESSION_BLACKLIST:"fcc19e4c9494452d9e8fde05ce5b0026,260,2554873377920922361,2745201443439123936,2745200842143701109,2745207580947400930,2745199502113902350,2745199845711287180,2745202495706113715,2745207061256356434,2745203934520160133,2745204291002445711,2745204909477737795,2745205253075122293,2745204600240091625,2768954163069212781,2806486756987564147,2806482466315226397,2806484768417702792,2806484390460579187,2806483595891628106,2856198770055723711,2856199491610230954,2856198078565987347,2745198819214101523,2901377256164439275,3002366673326196145,2856198770055723711,2806484768417702792,2856199491610230954,2806483595891628106,2768954163069212781,2806484390460579187,2806482466315226397,2806486756987564147,2856198078565987347,3012069034512628447,3056919513968942327,3060975702558142909",NO_DEVICE_ID_PARTNERS:"2074245483568304147,2215307220479662547,2222069010832063954,2388261640774383951,2393374215224752143,2545534615780864385,2695481750969397521,2695486883455316530"},e})(),this.config=new ye(this.window),this.featureFlagService=new we(this.env),this.errorServicePromise=new R,this.httpClient=new ne(this.window),this.cookieService=new q(this.window),this.localStorageService=new $(this.window),this.sessionStorageService=new X(this.window),this.sessionDetailsService=new ht(this.config,this.env,this.sessionStorageService,this.errorServicePromise.promise),this.launcherConnection=new Ee,this.launcherEventService=new Te(this.launcherConnection),this.widgetAPIService=new ut(this.env,this.config,this.httpClient,this.sessionDetailsService,this.featureFlagService),this.loggingService=new et(this.sessionDetailsService,this.widgetAPIService,this.config),this.errorService=new $e(this.window,this.loggingService),this.recogniserAccessor=new ae(this.cookieService,this.localStorageService),this.originValidator=(e=[window.location.origin,...[this.config.serviceUrlOverride].filter((e=>e))],new le(e)),this.frameFinderResponder=new ee(this.window,this.originValidator),this.pageInformationService=new Ge,this.placementConnectionMap=new Ue,this.placementConfigSet=new ke(this.errorService,this.sessionDetailsService,this.config,this.window,this.launcherConnection),this.recogniserService=new ot(this.widgetAPIService,this.recogniserAccessor,this.localStorageService,this.launcherConnection,this.errorService,this.window,this.env,this.sessionDetailsService,this.config),this.legacyRecogniserService=new Qe(this.window,this.env,this.widgetAPIService,this.sessionDetailsService,this.placementConfigSet),this.rdnService=new dt(this.widgetAPIService,this.sessionDetailsService,this.errorService),this.lifecycleEventService=new Ze(this.rdnService),this.placementService=new st(this.widgetAPIService,this.recogniserService,this.config,this.launcherEventService,this.sessionDetailsService,this.loggingService),this.metricRepository=new xe(this.widgetAPIService),this.rdnMetricStore=new ct(this.rdnService,this.pageInformationService,this.placementConfigSet,this.sessionDetailsService),this.metricsStore=new De(this.placementConfigSet,this.errorService,this.metricRepository),this.combinedMetricStore=new Ce(this.metricsStore,this.rdnMetricStore),this.metricsService=new Pe(this.combinedMetricStore,this.sessionDetailsService),this.lifecycleService=new Re(this.placementConfigSet,this.lifecycleEventService,this.config),this.errorServicePromise.resolve(this.errorService)}}const pt=async(e,t,i)=>{t.launcherConnection.setEngine(e),function(e,t){e.on("[C] CONTROLLER_INIT",(async e=>{e.send({firstPartyRecogniser:{}})})),e.on("[C] SELECT_PLACEMENTS",(({pageInformationService:e,placementService:t,placementConfigSet:i,lifecycleService:s,sessionDetailsService:n,metricsService:r,recogniserService:o})=>async a=>{var c,l,d;const h=a.getBody();await o.getSessionEtag(),r.triggerSelectionStart(h.pageInstanceId),s.onStartSelection(),n.setPageIdentifier(null!==(c=h.pageIdentifier)&&void 0!==c?c:""),h.url&&n.setHref(h.url);const u=await t.selectPlacements(h);i.setPageContext(u.pageContext);const g=null!==(l=h.pageInstanceId)&&void 0!==l?l:nt();e.setPageInstanceGuid(g,u.pageContext.pageInstanceGuid),n.setLimitedUse((null===(d=null==u?void 0:u.privacyControl)||void 0===d?void 0:d.limitedUse)||!1);const p=[];for(const e of u.placements){const t=nt();i.add(t,Object.assign({pageInstanceId:g},e)),p.push({pluginInstanceId:t,alias:e.plugin.id,configuration:i.generatePluginConfiguration(t),targetElementSelector:e.plugin.targetElementSelector,targetElementRelation:e.plugin.targetElementRelation,targetElementPosition:e.plugin.targetElementPosition})}a.send({sessionId:n.getSessionId(),context:{sessionId:n.getSessionId(),pageId:u.pageContext.pageId,pageInstanceGuid:u.pageContext.pageInstanceGuid,pageVariantName:u.pageContext.pageVariantName},placements:p}),p.length&&s.onCompleteSelection(),r.triggerSelectionEnd(h.pageInstanceId)})(t)),e.on("[C] FRAME_LOAD_END",(({placementConfigSet:e})=>async t=>{const i=t.getBody();e.triggerPluginLoading(i.id),t.send()})(t)),e.on("[P] PARTNER_TO_PLUGIN",(({placementConnectionMap:e})=>async t=>{const i=t.getHeaders()["placement-id"],s=await e.get(i);await G(s)(t)})(t)),e.on("[C] PLUGIN_REMOVED",(async e=>{e.send()})),e.on("[C] PUT_INFO",D),e.on("[C] LOG",(({loggingService:e})=>async t=>{const i=t.getBody();await e.log({code:i.code,additionalInformation:i.additionalInformation}),t.send()})(t)),e.on("[C] SET_ATTRIBUTES",(({sessionDetailsService:e,rdnService:t,launcherConnection:i,pageInformationService:s})=>async n=>{const r=n.getBody(),o=await e.getSessionIdAsync(),a=await s.getPageInstanceGuid(r.pageInstanceId)||void 0,c=[];for(const[e,t]of Object.entries(r.attributes)){const i=tt(t);i&&c.push({name:e,value:i})}t.triggerEvent({eventType:"CaptureAttributes",parentGuid:o,pageInstanceGuid:a,attributes:c}).then((()=>!0)).catch((()=>!1)).then((e=>{i.send("[L] ATTRIBUTES_CAPTURE_RESULT",{body:{isSuccess:e}})})),n.send()})(t))}(e,t),await i,await t.metricsService.triggerLoadComplete(),await e.send("[L] CONTROLLER_SETUP_COMPLETE"),t.window.setTimeout((async()=>{try{await(async(e,t,i)=>{await e.getLimitedUseAsync()||e.getNoTargeting()||(await Promise.all([e.getSessionIdAsync(),i.getPageContextAsync()]),await t.process())})(t.sessionDetailsService,t.legacyRecogniserService,t.placementConfigSet)}catch(e){t.errorService.reportError(e)}}),0),t.window.setTimeout((()=>{!async function(e,t){if(!(Math.random()>.2))try{await e.log({code:"LAUNCHER_VERSION",additionalInformation:{version:t.launcherVersion}})}catch(e){}}(t.loggingService,t.config)}),3e3)};const vt=new Date;!async function(){const e=new gt;e.metricsService.triggerControllerStart(vt);const t=e.recogniserService.getSessionEtag();J({targetOrigin:"*"}).onConnection.subscribe((async i=>{const s=new T(new v(n={connection:i,alias:"Controller"}),new w(n));var n;s.use((({errorService:e})=>async(t,i)=>{i&&!i.handled&&(i.handled=!0,await e.reportError(i))})(e)),s.use(b),s.use((e=>t=>{t.setResponseHeader("origin",e.location.origin),t.setResponseHeader("host",e.location.host),t.setResponseHeader("href",e.location.href),t.setResponseHeader("pathname",e.location.pathname)})(e.window)),s.addInterceptor(L(e.window)),s.addInterceptor((({errorService:e})=>t=>{if(!t.isResponse||!t.hasError||t.body.handled)return;const i=t.body;i.handled=!0,e.reportError(i)})(e)),s.on("[C] PUT_METRIC_EVENT",(({metricsService:e})=>async t=>{e.trigger(t.getBody()),t.send()})(e)),s.on("[C] ERROR",(({errorService:e})=>async t=>{const i=t.getBody();i.severity=i.severity||i.level,await e.reportError(i),t.send()})(e)),!1===e.launcherConnection.hasConnected?await pt(s,e,t):await async function(e,t){e.on("[C] GET_PLACEMENT_DETAILS",(({placementConfigSet:e,pluginRuntime:t,placementConnectionMap:i})=>async s=>{const n=s.getBody();i.add(n.id,t),e.triggerPluginLoaded(n.id),s.send({pageContext:e.getPageContext(),placement:e.get(n.id),display:e.getDisplaySettings(n.id)})})(Object.assign(Object.assign({},t),{pluginRuntime:e}))),e.on("[C] ISSUE_SIGNAL",(({rdnService:e,placementConfigSet:t})=>async i=>{var s;const n=i.getBody(),r=n,o={clientTimeStamp:n.overrideTimestamp?new Date(n.overrideTimestamp):void 0,transformedTrafficURL:n.transformedTrafficURL},a=null===(s=t.getPageContext())||void 0===s?void 0:s.pageInstanceGuid;a&&(r.pageInstanceGuid=a),e.triggerEvent(r,o),i.send(n)})(t)),e.on(he,(({placementConfigSet:e,placementConnectionMap:t,launcherConnection:i})=>async s=>{const{pluginInstanceId:n}=s.getBody(),r=Le(s),o=n||r,a=e.getRelations(o);if(a){const s=[];for(const e of a.children)s.push(i.send(he,{headers:{[Ne]:e}}));if(await Promise.all(s),void 0!==a.parentInstanceId){const i=await t.get(a.parentInstanceId);await i.send("[P] PLUGIN_IS_CLOSING",{body:{pluginInstanceId:o}});const s=e.getRelations(a.parentInstanceId);s.children=s.children.filter((e=>e!==o))}}s.send(),await i.send(he,{headers:{[Ne]:o}})})(t)),e.on("[L] PLUGIN_TO_PARTNER",G(t.launcherConnection)),e.on("[C] PLUGIN_TO_PLUGIN_OUTBOUND",(({placementConnectionMap:e})=>async t=>{const{to:i}=t.getBody(),s=await e.get(i);await s.send("[P] PLUGIN_TO_PLUGIN_INBOUND",{body:t.getBody()}),t.send()})(t)),e.on("[L] GET_FULFILLMENT_ATTRIBUTES",G(t.launcherConnection)),e.on(ue,G(t.launcherConnection)),e.on("[L] PLUGIN_RESIZED",G(t.launcherConnection)),e.on("[L] PUT_DISPLAY_SETTINGS",(({placementConfigSet:e})=>async t=>{const i=t.getBody();e.setDisplaySettings(Le(t),i)})(t),G(t.launcherConnection)),e.on("[C] CREATE_PLUGIN",(({placementConfigSet:e,launcherConnection:t,loggingService:i})=>async s=>{const{config:n,parentInstanceId:r,url:o,name:a,configurables:c,fonts:l}=s.getBody(),d=nt(),h=e.get(r);if(!h)throw new fe(`CreatePlugin: Failed to create. No parent instance config found for ${r}.`,{code:"CREATE_CHILD_PLUGIN"});o&&!a&&i.log({code:"URL_CHILD_PLUGIN_CREATED",additionalInformation:{url:o}}),e.add(d,{plugin:{id:"",url:o,name:a,config:n},placementConfigurables:c||h.placementConfigurables,fonts:l||h.fonts,pageInstanceId:h.pageInstanceId}),e.getRelations(d).parentInstanceId=r,e.getRelations(r).children.push(d),s.send({pluginInstanceId:d});const u=e.generatePluginConfiguration(d);await t.send("[L] CREATE_PLUGIN",{body:{pluginInstanceId:d,parentInstanceId:r,configuration:u}})})(t)),e.on("[C] LOG_METRIC",(({metricRepository:e,config:t})=>async i=>{const{metricName:s,duration:n}=i.getBody(),r=i.getHeaders()["original-sender-alias"],{integration:o}=t,a={metricName:s,value:n,pluginAlias:r,integration:o};try{await e.submit(a),i.send()}catch(e){i.sendError({name:"LogMetricHandlerError",message:"Unable to submit metric"})}})(t))}(s,e)}))}()})();